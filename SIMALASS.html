<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SIMALAS - Sistem Manajemen Kelas</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
  /* ---------- CORE THEME (keaslian & styling preserved) ---------- */
  *{box-sizing:border-box;margin:0;padding:0}
  :root{
    --primary:#2563eb;--primary-dark:#1e40af;--secondary:#10b981;
    --danger:#ef4444;--warning:#f59e0b;--dark:#1e293b;--light:#f8fafc;--border:#e2e8f0;
  }
  body{
    font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    min-height:100vh;padding:20px;transition:background .3s;
  }
  .container{max-width:1400px;margin:0 auto;}

  /* ---------- LOGIN OVERLAY (modern) ---------- */
  #loginOverlay{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background:linear-gradient(180deg,rgba(10,8,30,0.45),rgba(10,8,30,0.55));
    z-index:9999;padding:20px;
  }
  .login-card{
    width:460px;max-width:100%;border-radius:16px;overflow:hidden;
    background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(255,255,255,0.98));
    box-shadow:0 25px 80px rgba(2,6,23,0.6);backdrop-filter: blur(6px);
    animation:slideUp .45s ease;
  }
  .login-header{background:linear-gradient(90deg,var(--primary),#7b61f2);padding:22px;color:white}
  .login-header h1{font-size:1.25rem;margin-bottom:6px}
  .login-header p{opacity:.95;font-size:.9rem;margin:0}
  .login-body{padding:20px;background:white}
  .form-row{margin-bottom:12px}
  .form-row label{display:block;font-weight:600;color:var(--dark);margin-bottom:6px}
  .form-row input{width:100%;padding:10px;border-radius:10px;border:2px solid var(--border)}
  .login-actions{display:flex;gap:10px;margin-top:10px}
  .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .btn-primary{background:var(--primary);color:white}
  .btn-light{background:var(--light);color:var(--dark);border:1px solid var(--border)}
  .small-actions{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
  .small-link{color:#64748b;font-size:.9rem;cursor:pointer;text-decoration:underline}
  .error-text{color:var(--danger);margin-top:8px;font-weight:700;display:none}

  @keyframes slideUp{from{transform:translateY(18px);opacity:0}to{transform:none;opacity:1}}

  /* ---------- APP (original) ---------- */
  .header{background:white;padding:25px 30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.1);margin-bottom:30px;display:flex;justify-content:space-between;align-items:center}
  .logo{display:flex;align-items:center;gap:15px}
  .logo i{font-size:2.5rem;color:var(--primary)}
  .logo-text h1{font-size:1.8rem;color:var(--dark);margin-bottom:5px}
  .logo-text p{color:#64748b;font-size:0.9rem}
  .user-info{display:flex;align-items:center;gap:15px}
  .user-avatar{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;color:white;font-size:1.2rem;font-weight:bold}
  .user-details h3{font-size:1rem;color:var(--dark)}
  .user-details p{font-size:0.85rem;color:#64748b}

  .nav-tabs{background:white;padding:15px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.1);margin-bottom:30px;display:flex;gap:10px;overflow-x:auto}
  .nav-tab{padding:12px 25px;border:none;background:transparent;color:#64748b;font-size:0.95rem;font-weight:600;cursor:pointer;border-radius:10px;transition:all .3s;white-space:nowrap}
  .nav-tab:hover{background:var(--light);color:var(--primary)}
  .nav-tab.active{background:var(--primary);color:white}
  .nav-tab i{margin-right:8px}

  .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:25px;margin-bottom:30px}
  .stat-card{background:white;padding:25px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.1);position:relative;overflow:hidden}
  .stat-card::before{content:'';position:absolute;top:0;right:0;width:100px;height:100px;background:var(--primary);opacity:0.1;border-radius:0 0 0 100%}
  .stat-icon{width:60px;height:60px;border-radius:15px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;margin-bottom:15px;color:white}
  .stat-card:nth-child(1) .stat-icon{background:linear-gradient(135deg,#667eea,#764ba2)}
  .stat-card:nth-child(2) .stat-icon{background:linear-gradient(135deg,#f093fb,#f5576c)}
  .stat-card:nth-child(3) .stat-icon{background:linear-gradient(135deg,#4facfe,#00f2fe)}
  .stat-card:nth-child(4) .stat-icon{background:linear-gradient(135deg,#43e97b,#38f9d7)}
  .stat-value{font-size:2rem;font-weight:bold;color:var(--dark);margin-bottom:5px}
  .stat-label{color:#64748b;font-size:0.9rem}

  .content-section{display:none;animation:fadeIn .3s}
  .content-section.active{display:block}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

  .content-grid{display:grid;grid-template-columns:2fr 1fr;gap:25px}
  .card{background:white;padding:25px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.1)}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid var(--border)}
  .card-title{font-size:1.3rem;color:var(--dark);font-weight:600}
  .btn-sm{padding:6px 12px;font-size:0.85rem}
  .btn-primary{background:var(--primary);color:white;border-radius:10px;padding:10px 14px;border:0;cursor:pointer}
  .btn-danger{background:var(--danger);color:white;border-radius:10px;padding:10px 14px;border:0;cursor:pointer}
  .btn-success{background:var(--secondary);color:white;border-radius:10px;padding:10px 14px;border:0;cursor:pointer}
  .material-list{display:flex;flex-direction:column;gap:15px}
  .material-item{padding:18px;border:2px solid var(--border);border-radius:12px;display:flex;align-items:center;gap:15px;transition:all .3s}
  .material-item:hover{border-color:var(--primary);background:var(--light);transform:translateX(5px)}
  .material-icon{width:50px;height:50px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:white}
  .material-icon.pdf{background:linear-gradient(135deg,#ef4444,#dc2626)}
  .material-icon.doc{background:linear-gradient(135deg,#3b82f6,#2563eb)}
  .material-icon.ppt{background:linear-gradient(135deg,#f59e0b,#d97706)}
  .material-info{flex:1}
  .material-title{font-weight:600;color:var(--dark);margin-bottom:5px}
  .material-meta{font-size:0.85rem;color:#64748b}

  .task-list{display:flex;flex-direction:column;gap:15px}
  .task-item{padding:18px;border:2px solid var(--border);border-radius:12px;transition:all .3s}
  .task-item.completed{background:#f0fdf4;border-color:var(--secondary)}
  .task-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:12px}
  .task-checkbox{width:24px;height:24px;cursor:pointer}
  .task-title{font-weight:600;color:var(--dark);margin-bottom:8px}
  .task-deadline{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:#fef3c7;color:#92400e;border-radius:8px;font-size:0.85rem;font-weight:600}
  .task-deadline.urgent{background:#fee2e2;color:#991b1b}
  .task-deadline.completed{background:#d1fae5;color:#065f46}
  .kas-list{display:flex;flex-direction:column;gap:12px}
  .kas-item{display:flex;justify-content:space-between;align-items:center;padding:15px;border:2px solid var(--border);border-radius:10px;transition:all .3s}
  .kas-item:hover{border-color:var(--primary)}
  .kas-name{font-weight:600;color:var(--dark)}
  .kas-status{padding:6px 16px;border-radius:20px;font-size:0.85rem;font-weight:600}
  .kas-status.paid{background:#d1fae5;color:#065f46}
  .kas-status.unpaid{background:#fee2e2;color:#991b1b}
  .upcoming-task{padding:15px;background:var(--light);border-radius:10px;margin-bottom:12px;border-left:4px solid var(--warning)}
  .upcoming-task-title{font-weight:600;color:var(--dark);margin-bottom:6px}
  .upcoming-task-time{font-size:0.85rem;color:#64748b}

  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{background:white;padding:30px;border-radius:15px;max-width:520px;width:92%;animation:slideUp .3s}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
  .modal-title{font-size:1.5rem;color:var(--dark)}
  .close-modal{font-size:1.2rem;cursor:pointer;color:#64748b;border:none;background:none}
  .form-group{margin-bottom:16px}
  .form-label{display:block;margin-bottom:8px;color:var(--dark);font-weight:600}
  .form-control{width:100%;padding:10px;border:2px solid var(--border);border-radius:10px}
  @media (max-width:768px){.content-grid{grid-template-columns:1fr}.header{flex-direction:column;gap:15px;text-align:center}.nav-tabs{flex-direction:column}}
</style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay" role="dialog" aria-modal="true">
  <div class="login-card" aria-labelledby="loginTitle">
    <div class="login-header">
      <h1 id="loginTitle"><i class="fas fa-graduation-cap"></i> SIMALAS</h1>
      <p>Masuk dengan NIM & password</p>
    </div>

    <div class="login-body">
      <div class="form-row">
        <label for="loginNIM">NIM</label>
        <input id="loginNIM" placeholder="contoh: 240602010" />
      </div>
      <div class="form-row">
        <label for="loginPass">Password</label>
        <input id="loginPass" type="password" placeholder="masukkan password" />
      </div>

      <div style="display:flex;gap:10px;margin-top:8px">
        <button id="btnLogin" class="btn btn-primary" style="flex:1"><i class="fas fa-right-to-bracket"></i> Login</button>
        <button id="btnReset" class="btn btn-light" title="Reset data ke kondisi awal" style="flex:0 0 auto"><i class="fas fa-rotate-left"></i></button>
      </div>

      <div id="loginError" class="error-text">NIM atau password salah.</div>
    </div>
  </div>
</div>

<!-- APP CONTAINER -->
<div class="container" id="app">
  <div class="header">
    <div class="logo">
      <i class="fas fa-graduation-cap"></i>
      <div class="logo-text">
        <h1>SIMALAS</h1>
        <p>Sistem Manajemen Kelas</p>
      </div>
    </div>
    <div class="user-info">
      <div class="user-details">
        <h3 id="displayRole">Mahasiswa</h3>
        <p id="displayUser">Kelas A - PAGI</p>
      </div>
      <div class="user-avatar" id="displayAvatar"><i class="fas fa-user"></i></div>
    </div>
  </div>

  <div class="nav-tabs" id="nav">
    <button class="nav-tab active" onclick="showSection('dashboard')"><i class="fas fa-home"></i> Dashboard</button>
    <button class="nav-tab" onclick="showSection('materi')"><i class="fas fa-book"></i> Materi Kuliah</button>
    <button class="nav-tab" onclick="showSection('tugas')"><i class="fas fa-tasks"></i> Tugas</button>
    <button class="nav-tab" onclick="showSection('kas')"><i class="fas fa-wallet"></i> Kas Kelas</button>
    <button class="nav-tab" id="tabChangePass" style="display:none" onclick="openModal('modalChangePass')"><i class="fas fa-key"></i> Ubah Password</button>
    <button class="nav-tab" id="tabLogout" style="display:none" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="content-section active">
    <div class="dashboard-grid">
      <div class="stat-card"><div class="stat-icon"><i class="fas fa-book"></i></div><div class="stat-value" id="statMateri">0</div><div class="stat-label">Materi Tersedia</div></div>
      <div class="stat-card"><div class="stat-icon"><i class="fas fa-tasks"></i></div><div class="stat-value" id="statTugas">0/0</div><div class="stat-label">Tugas Selesai</div></div>
      <div class="stat-card"><div class="stat-icon"><i class="fas fa-clock"></i></div><div class="stat-value" id="statDead">0</div><div class="stat-label">Deadline Mendekat</div></div>
      <div class="stat-card"><div class="stat-icon"><i class="fas fa-check-circle"></i></div><div class="stat-value" id="statKas">-</div><div class="stat-label">Status Kas Bulan Ini</div></div>
    </div>

    <div class="content-grid">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Materi Terbaru</h2>
          <div>
            <button id="btnTopUpload" class="btn btn-primary btn-sm" onclick="openModal('modalUpload')" style="display:none"><i class="fas fa-plus"></i> Upload Materi</button>
          </div>
        </div>
        <div class="material-list" id="materiPreview"></div>
      </div>

      <div class="card">
        <div class="card-header"><h2 class="card-title">Deadline Mendekat</h2></div>
        <div id="upcoming"></div>
      </div>
    </div>
  </div>

  <!-- Materi -->
  <div id="materi" class="content-section">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Materi Kuliah</h2>
        <div><button id="btnUploadPage" class="btn btn-primary" onclick="openModal('modalUpload')" style="display:none"><i class="fas fa-plus"></i> Upload Materi</button></div>
      </div>
      <div class="material-list" id="materiList"></div>
    </div>
  </div>

  <!-- Tugas -->
  <div id="tugas" class="content-section">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Daftar Tugas</h2>
        <div><button id="btnAddTugas" class="btn btn-primary" onclick="openModal('modalAddTugas')" style="display:none"><i class="fas fa-plus"></i> Tambah Tugas</button></div>
      </div>
      <div class="task-list" id="tugasList"></div>
    </div>
  </div>

  <!-- Kas -->
  <div id="kas" class="content-section">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Kas Kelas - Oktober 2025</h2>
        <div><button class="btn btn-success" onclick="exportKas()"><i class="fas fa-download"></i> Export Excel</button></div>
      </div>
      <div class="kas-list" id="kasList"></div>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="modalUpload" class="modal"><div class="modal-content">
  <div class="modal-header"><h3 class="modal-title">Upload Materi</h3><button class="close-modal" onclick="closeModal('modalUpload')"><i class="fas fa-times"></i></button></div>
  <form onsubmit="handleUpload(event)">
    <div class="form-group"><label class="form-label">Nama Mata Kuliah</label><input class="form-control" name="course" required></div>
    <div class="form-group"><label class="form-label">Judul Materi</label><input class="form-control" name="title" required></div>
    <div class="form-group"><label class="form-label">File</label><input type="file" class="form-control" name="file" accept=".pdf,.doc,.docx,.ppt,.pptx" required></div>
    <button type="submit" class="btn btn-primary" style="width:100%"><i class="fas fa-upload"></i> Upload</button>
  </form>
</div></div>

<div id="modalAddTugas" class="modal"><div class="modal-content">
  <div class="modal-header"><h3 class="modal-title">Tambah Tugas</h3><button class="close-modal" onclick="closeModal('modalAddTugas')"><i class="fas fa-times"></i></button></div>
  <form onsubmit="handleAddTugas(event)">
    <div class="form-group"><label class="form-label">Mata Kuliah</label><input class="form-control" name="course" required></div>
    <div class="form-group"><label class="form-label">Nama Tugas</label><input class="form-control" name="title" required></div>
    <div class="form-group"><label class="form-label">Deadline</label><input type="datetime-local" class="form-control" name="deadline" required></div>
    <div class="form-group"><label class="form-label">Deskripsi</label><textarea class="form-control" name="desc" rows="3"></textarea></div>
    <button type="submit" class="btn btn-primary" style="width:100%"><i class="fas fa-plus"></i> Tambah</button>
  </form>
</div></div>

<div id="modalChangePass" class="modal"><div class="modal-content">
  <div class="modal-header"><h3 class="modal-title">Ubah Password</h3><button class="close-modal" onclick="closeModal('modalChangePass')"><i class="fas fa-times"></i></button></div>
  <form id="formChangePass" onsubmit="handleChangePass(event)">
    <div class="form-group"><label class="form-label">Password Lama</label><input type="password" id="oldPass" class="form-control" required></div>
    <div class="form-group"><label class="form-label">Password Baru</label><input type="password" id="newPass" class="form-control" required></div>
    <div class="form-group"><label class="form-label">Konfirmasi Password</label><input type="password" id="confPass" class="form-control" required></div>
    <button type="submit" class="btn btn-primary" style="width:100%">Simpan</button>
  </form>
</div></div>

<script>
/* ================== APP LOGIC ================== */
/* seed user list (from your list). Ketua=240602010, Bendahara=240602009 */
const seedNames = {
  "240602002":"AISYAH GRISSEETA AZ-ZAHRA","240602004":"MUHAMMAD NUR ZAKARIA","240602005":"ARIF FATHUR ROHMAN",
  "240602009":"FEBRY WULANDARI","240602010":"MUHAMMAD VIGAR SEPTIANTA PRATAMA","240602011":"ACHMAD BACHTIAR PRIMADANI",
  "240602012":"DAFFA ALFIAN FALIH ABNI","240602014":"MUHAMMAD RIZQY AQILAH RAZAN","240602017":"MUHAMMAD FAHMI HASAN",
  "240602019":"DIMAS MAKHZUM MUFRIH","240602020":"AMELIA RIZQIYA","240602021":"ANDIKA EKA PUTRA YULIANTO",
  "240602022":"WINNIE NADYA PRANESTI","240602023":"MUHAMMAD ZAKI AZHARI","240602024":"MOHAMMAD DANI ANWAR",
  "240602025":"AISYATUL BARIROH","240602026":"ROHMAH NUR HIDAYAH","240602027":"AHMAD ISNAINIL FADHILI",
  "240602028":"HAIM FARADIS","240602029":"NAZWA ENDHITA HARIYANTO","240602030":"MUHAMMAD KEVIN BAYU MAULIDI",
  "240602031":"KOKOH HARI DWI SAPUTRA","240602032":"MUHAMMAD FATCHUR ROZI ALAMSYAH","240602033":"AHMAD RAFIF",
  "240602034":"NABILA DWI PUTRI ZASKIA","240602035":"CITRA ANGGUN PRATIWI","240602036":"MUHAMMAD ANDIKA AULIA HAQ",
  "240602038":"MUHAMMAD FACHRUL","240602039":"REYVANDI RAHMAD SAPUTRA"
};

const ROLE_KETUA = 'ketua';
const ROLE_BENDAHARA = 'bendahara';
const ROLE_MAHASISWA = 'mahasiswa';

/* default seed data for materials, tasks, kas */
const DEFAULT_MATERIALS = [
  {id:1,title:'Algoritma dan Pemrograman - Bab 5',type:'pdf',size:'2.4 MB',date:'2 hari yang lalu',filename:null},
  {id:2,title:'Basis Data - Normalisasi',type:'ppt',size:'5.1 MB',date:'4 hari yang lalu',filename:null},
  {id:3,title:'Rekayasa Perangkat Lunak - UML',type:'doc',size:'1.8 MB',date:'1 minggu yang lalu',filename:null},
  {id:4,title:'Jaringan Komputer - TCP/IP',type:'pdf',size:'3.2 MB',date:'2 minggu yang lalu',filename:null}
];
const DEFAULT_TASKS = [
  {id:1,title:'Tugas Algoritma - Sorting',course:'Algoritma',deadline:'2025-10-16T20:00'},
  {id:2,title:'Laporan Basis Data',course:'Basis Data',deadline:'2025-10-18T23:59'},
  {id:3,title:'Presentasi RPL',course:'RPL',deadline:'2025-10-20T14:00'},
  {id:4,title:'Quiz Jaringan Komputer',course:'Jarkom',deadline:'2025-10-12T10:00'}
];
const DEFAULT_KAS = [
  {id:1,name:'Ahmad Fauzi',paid:true},{id:2,name:'Budi Santoso',paid:true},{id:3,name:'Citra Dewi',paid:false},
  {id:4,name:'Dian Purnama',paid:true},{id:5,name:'Eka Wijaya',paid:false},{id:6,name:'Farah Nabila',paid:true}
];

/* ---------- LocalStorage wrappers ---------- */
function initAppData(){
  if(!localStorage.getItem('simalas_users')){
    const users = {};
    for(const nim in seedNames){
      users[nim] = {
        nim,
        name: seedNames[nim],
        role: (nim==='240602010')?ROLE_KETUA: (nim==='240602009')?ROLE_BENDAHARA:ROLE_MAHASISWA,
        password: (nim==='240602010')? 'ketua123' : (nim==='240602009')? 'bendahara123' : 'mahasiswa123'
      };
    }
    localStorage.setItem('simalas_users', JSON.stringify(users));
  }
  if(!localStorage.getItem('simalas_materials')) localStorage.setItem('simalas_materials', JSON.stringify(DEFAULT_MATERIALS));
  if(!localStorage.getItem('simalas_tasks')) localStorage.setItem('simalas_tasks', JSON.stringify(DEFAULT_TASKS));
  if(!localStorage.getItem('simalas_task_status')) localStorage.setItem('simalas_task_status', JSON.stringify({}));
  if(!localStorage.getItem('simalas_kas')) localStorage.setItem('simalas_kas', JSON.stringify(DEFAULT_KAS));
}
initAppData();

function getUsers(){ return JSON.parse(localStorage.getItem('simalas_users')||'{}') }
function saveUsers(u){ localStorage.setItem('simalas_users', JSON.stringify(u)) }
function setCurrentUser(nim){ const u = getUsers()[nim]; if(u) localStorage.setItem('simalas_current', JSON.stringify(u)) }
function clearCurrent(){ localStorage.removeItem('simalas_current') }
function getCurrent(){ return JSON.parse(localStorage.getItem('simalas_current')||'null') }

function getMaterials(){ return JSON.parse(localStorage.getItem('simalas_materials')||'[]') }
function saveMaterials(m){ localStorage.setItem('simalas_materials', JSON.stringify(m)) }
function getTasks(){ return JSON.parse(localStorage.getItem('simalas_tasks')||'[]') }
function saveTasks(t){ localStorage.setItem('simalas_tasks', JSON.stringify(t)) }
function getTaskStatus(){ return JSON.parse(localStorage.getItem('simalas_task_status')||'{}') }
function saveTaskStatus(s){ localStorage.setItem('simalas_task_status', JSON.stringify(s)) }
function getKas(){ return JSON.parse(localStorage.getItem('simalas_kas')||'[]') }
function saveKas(k){ localStorage.setItem('simalas_kas', JSON.stringify(k)) }

/* ---------- UI elements ---------- */
const loginOverlay = document.getElementById('loginOverlay');
const btnLogin = document.getElementById('btnLogin');
const btnReset = document.getElementById('btnReset');
const demoLogin = document.getElementById('demoLogin');
const loginError = document.getElementById('loginError');
const loginNIM = document.getElementById('loginNIM');
const loginPass = document.getElementById('loginPass');

/* ---------- AUTH (login) ---------- */
btnLogin.addEventListener('click', doLogin);
demoLogin.addEventListener('click', ()=> {
  loginNIM.value = '240602002';
  loginPass.value = 'mahasiswa123';
  doLogin();
});
btnReset.addEventListener('click', ()=> {
  if(!confirm('Reset semua data (users, materials, tasks, kas) ke kondisi awal?')) return;
  localStorage.removeItem('simalas_users'); localStorage.removeItem('simalas_materials'); localStorage.removeItem('simalas_tasks');
  localStorage.removeItem('simalas_task_status'); localStorage.removeItem('simalas_kas'); localStorage.removeItem('simalas_current');
  initAppData();
  location.reload();
});

function doLogin(){
  loginError.style.display='none';
  const nim = (loginNIM.value||'').trim();
  const pass = (loginPass.value||'').trim();
  if(!nim || !pass){ loginError.innerText='Isi NIM & password.'; loginError.style.display='block'; return; }
  const users = getUsers();
  const user = users[nim];
  if(!user){ loginError.innerText='NIM tidak terdaftar.'; loginError.style.display='block'; return; }
  if(user.password !== pass){ loginError.innerText='NIM atau password salah.'; loginError.style.display='block'; return; }
  // success
  setCurrentUser(nim);
  onLogin();
}

/* ---------- ON LOGIN - setup UI according role ---------- */
function onLogin(){
  const cur = getCurrent();
  if(!cur) return;
  // hide overlay
  loginOverlay.style.display='none';
  document.body.classList.add('logged-in');

  // header
  const displayRole = document.getElementById('displayRole');
  const displayUser = document.getElementById('displayUser');
  displayRole.innerText = (cur.role===ROLE_KETUA ? 'Ketua Kelas - ' : cur.role===ROLE_BENDAHARA ? 'Bendahara - ' : 'Mahasiswa - ') + cur.name;
  displayUser.innerText = 'NIM: ' + cur.nim;
  const avatar = document.getElementById('displayAvatar');
  avatar.innerText = cur.name ? cur.name.split(' ').map(x=>x[0]).slice(0,2).join('') : '';
  // nav items
  const isAdmin = (cur.role===ROLE_KETUA || cur.role===ROLE_BENDAHARA);
  document.getElementById('tabChangePass').style.display = isAdmin ? 'inline-block' : 'none';
  document.getElementById('tabLogout').style.display = 'inline-block';
  document.getElementById('btnTopUpload').style.display = isAdmin ? 'inline-block' : 'none';
  document.getElementById('btnUploadPage').style.display = isAdmin ? 'inline-block' : 'none';
  document.getElementById('btnAddTugas').style.display = isAdmin ? 'inline-block' : 'none';

  // render
  renderMaterials(); renderTasks(); renderKas(); renderStats();
}

/* ---------- RENDERING FUNCTIONS ---------- */
function showSection(id){
  document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  const section = document.getElementById(id);
  if(section) section.classList.add('active');
  // set active nav by text matching (best effort)
  const navs = Array.from(document.querySelectorAll('.nav-tab'));
  const target = navs.find(n => n.textContent.trim().toLowerCase().includes(id));
  if(target){ target.classList.add('active'); } else { navs[0].classList.add('active'); }
}

/* Materials */
function renderMaterials(){
  const mats = getMaterials();
  const preview = document.getElementById('materiPreview');
  const pageList = document.getElementById('materiList');
  const cur = getCurrent();
  const isAdmin = cur && (cur.role===ROLE_KETUA || cur.role===ROLE_BENDAHARA);
  const html = mats.map(m => `
    <div class="material-item" data-id="${m.id}">
      <div class="material-icon ${m.type}"><i class="fas fa-file-${m.type==='pdf'?'pdf':m.type==='doc'?'word':'powerpoint'}"></i></div>
      <div class="material-info"><div class="material-title">${escapeHtml(m.title)}</div><div class="material-meta">Diupload ${m.date} • ${m.size}</div></div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary btn-sm" onclick="downloadMaterial(${m.id})"><i class="fas fa-download"></i></button>
        ${isAdmin ? `<button class="btn btn-danger btn-sm" onclick="confirmDeleteMaterial(${m.id})"><i class="fas fa-trash"></i></button>` : ''}
      </div>
    </div>
  `).join('');
  preview.innerHTML = html;
  pageList.innerHTML = html;
}

/* Tasks */
function renderTasks(){
  const tasks = getTasks();
  const status = getTaskStatus();
  const cur = getCurrent();
  const list = document.getElementById('tugasList');
  const html = tasks.map(t => {
    const d = new Date(t.deadline);
    const daysLeft = Math.ceil((d - new Date())/(1000*60*60*24));
    const urgent = daysLeft <= 2 && daysLeft >= 0;
    const key = `${t.id}_${cur?cur.nim:'guest'}`;
    const done = !!status[key];
    return `
      <div class="task-item ${done ? 'completed' : ''}">
        <div class="task-header">
          <div style="flex:1">
            <div class="task-title">${escapeHtml(t.title)}</div>
            <div style="color:#64748b;font-size:.85rem;margin-top:5px"><i class="fas fa-book"></i> ${escapeHtml(t.course)}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" class="task-checkbox" ${done ? 'checked' : ''} onchange="toggleTask(${t.id})">
            ${ (cur && (cur.role===ROLE_KETUA||cur.role===ROLE_BENDAHARA)) ? `<button class="btn btn-danger btn-sm" onclick="confirmDeleteTask(${t.id})"><i class="fas fa-trash"></i></button>` : '' }
          </div>
        </div>
        <div class="task-deadline ${urgent && !done ? 'urgent' : ''} ${done ? 'completed' : ''}"><i class="fas fa-clock"></i> ${done ? 'Selesai' : formatDeadline(d)}</div>
      </div>
    `;
  }).join('');
  list.innerHTML = html;
  // upcoming
  const upcoming = document.getElementById('upcoming');
  const upHtml = tasks.slice(0,3).map(t => `<div class="upcoming-task"><div class="upcoming-task-title">${escapeHtml(t.title)}</div><div class="upcoming-task-time"><i class="fas fa-clock"></i> ${formatDeadline(new Date(t.deadline))}</div></div>`).join('');
  upcoming.innerHTML = upHtml;
}

/* Kas */
function renderKas(){
  const ks = getKas();
  const list = document.getElementById('kasList');
  const cur = getCurrent();
  const isAdmin = cur && (cur.role===ROLE_KETUA || cur.role===ROLE_BENDAHARA);
  const html = `
    <div style="background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;padding:25px;border-radius:12px;margin-bottom:20px">
      <div style="font-size:.9rem;margin-bottom:10px">Status Pembayaran</div>
      <div style="font-size:2rem;font-weight:bold;margin-bottom:5px">${ks.filter(k=>k.paid).length}/${ks.length} Mahasiswa</div>
      <div style="font-size:.9rem">sudah membayar kas bulan ini</div>
    </div>
    ${ks.map(k => `<div class="kas-item"><div class="kas-name"><i class="fas fa-user"></i> ${escapeHtml(k.name)}</div><span class="kas-status ${k.paid?'paid':'unpaid'}" ${isAdmin?`onclick="toggleKas(${k.id})" style="cursor:pointer"`:''}>${k.paid?'✓ Sudah Bayar':'✗ Belum Bayar'}</span></div>`).join('')}
  `;
  list.innerHTML = html;
}

/* Stats */
function renderStats(){
  const mats = getMaterials();
  const tasks = getTasks();
  const statuses = getTaskStatus();
  const cur = getCurrent();
  document.getElementById('statMateri').innerText = mats.length;
  const doneCount = cur ? Object.keys(statuses).filter(k => k.endsWith('_'+cur.nim) && statuses[k]).length : 0;
  document.getElementById('statTugas').innerText = `${doneCount}/${tasks.length}`;
  const near = tasks.filter(t => { const d=new Date(t.deadline); const days=Math.ceil((d-new Date())/(1000*60*60*24)); return days>=0 && days<=7 }).length;
  document.getElementById('statDead').innerText = near;
  const ks = getKas(); document.getElementById('statKas').innerText = (ks.filter(k=>k.paid).length === ks.length) ? 'Lunas' : 'Belum Lunas';
}

/* ---------- ACTIONS ---------- */
function handleUpload(e){
  e.preventDefault();
  const cur = getCurrent();
  if(!cur || !(cur.role===ROLE_KETUA || cur.role===ROLE_BENDAHARA)){ alert('Akses ditolak'); return; }
  const form = e.target;
  const course = form.course.value.trim();
  const title = form.title.value.trim();
  const file = form.file.files[0];
  if(!course || !title || !file){ alert('Lengkapi semua field'); return; }
  const ext = file.name.split('.').pop().toLowerCase();
  let type='doc'; if(ext==='pdf') type='pdf'; else if(ext.includes('ppt')) type='ppt';
  const mats = getMaterials();
  const size = (file.size/(1024*1024)).toFixed(1)+' MB';
  mats.unshift({id:(mats.length?Math.max(...mats.map(m=>m.id)):0)+1, title, type, size, date:'Baru saja', filename:file.name});
  saveMaterials(mats);
  closeModal('modalUpload'); renderMaterials(); renderStats(); alert('Materi berhasil diupload (simulasi lokal).');
  form.reset();
}

function handleAddTugas(e){
  e.preventDefault();
  const cur = getCurrent();
  if(!cur || !(cur.role===ROLE_KETUA || cur.role===ROLE_BENDAHARA)){ alert('Akses ditolak'); return; }
  const form = e.target;
  const course = form.course.value.trim();
  const title = form.title.value.trim();
  const deadline = form.deadline.value;
  if(!course||!title||!deadline){ alert('Lengkapi data tugas'); return; }
  const tasks = getTasks();
  tasks.unshift({id:(tasks.length?Math.max(...tasks.map(t=>t.id)):0)+1, title, course, deadline});
  saveTasks(tasks);
  closeModal('modalAddTugas'); renderTasks(); renderStats(); alert('Tugas ditambahkan.');
  form.reset();
}

/* Toggle task completion per user */
function toggleTask(taskId){
  const cur = getCurrent();
  if(!cur){ alert('Silakan login'); return; }
  const key = `${taskId}_${cur.nim}`;
  const status = getTaskStatus();
  status[key] = !status[key];
  saveTaskStatus(status);
  renderTasks(); renderStats();
}

/* Toggle kas (admin) */
function toggleKas(id){
  const cur = getCurrent();
  if(!cur || !(cur.role===ROLE_KETUA || cur.role===ROLE_BENDAHARA)){ alert('Akses ditolak'); return; }
  const ks = getKas();
  const idx = ks.findIndex(k=>k.id===id);
  if(idx>-1){ ks[idx].paid = !ks[idx].paid; saveKas(ks); renderKas(); renderStats(); }
}

/* Download material (simulate) */
function downloadMaterial(id){
  const m = getMaterials().find(x=>x.id===id);
  if(!m) return alert('File tidak ditemukan');
  alert('Simulasi download: ' + m.title + (m.filename?(' (file: '+m.filename+')'):''));
}

/* Delete confirmations */
function confirmDeleteMaterial(id){ if(confirm('Hapus materi ini?')) deleteMaterial(id); }
function deleteMaterial(id){
  const cur = getCurrent(); if(!cur || !(cur.role===ROLE_KETUA||cur.role===ROLE_BENDAHARA)){ alert('Akses ditolak'); return; }
  const mats = getMaterials().filter(m=>m.id!==id); saveMaterials(mats); renderMaterials(); renderStats();
}
function confirmDeleteTask(id){ if(confirm('Hapus tugas ini?')) deleteTask(id); }
function deleteTask(id){
  const cur = getCurrent(); if(!cur || !(cur.role===ROLE_KETUA||cur.role===ROLE_BENDAHARA)){ alert('Akses ditolak'); return; }
  let tasks = getTasks().filter(t=>t.id!==id); saveTasks(tasks);
  const status = getTaskStatus(); for(const k of Object.keys(status)){ if(k.startsWith(id+'_')) delete status[k]; } saveTaskStatus(status);
  renderTasks(); renderStats();
}

/* Change password (admin only) */
function handleChangePass(e){
  e.preventDefault();
  const cur = getCurrent(); if(!cur) return alert('Silakan login');
  if(!(cur.role===ROLE_KETUA||cur.role===ROLE_BENDAHARA)) return alert('Akses ditolak');
  const oldP = document.getElementById('oldPass').value;
  const newP = document.getElementById('newPass').value;
  const conf = document.getElementById('confPass').value;
  if(newP !== conf) return alert('Konfirmasi password tidak sama');
  const users = getUsers();
  if(users[cur.nim].password !== oldP) return alert('Password lama salah');
  users[cur.nim].password = newP; saveUsers(users); closeModal('modalChangePass'); alert('Password berhasil diubah');
  // clear fields
  document.getElementById('oldPass').value=''; document.getElementById('newPass').value=''; document.getElementById('confPass').value='';
}

/* Logout */
function logout(){
  if(!confirm('Logout sekarang?')) return;
  clearCurrent();
  // reset UI
  loginOverlay.style.display='flex';
  document.body.classList.remove('logged-in');
  document.getElementById('displayRole').innerText='Mahasiswa';
  document.getElementById('displayUser').innerText='Kelas TI-3A';
  document.getElementById('displayAvatar').innerHTML='<i class="fas fa-user"></i>';
  document.getElementById('tabChangePass').style.display='none';
  document.getElementById('tabLogout').style.display='none';
  document.getElementById('btnTopUpload').style.display='none';
  document.getElementById('btnUploadPage').style.display='none';
  document.getElementById('btnAddTugas').style.display='none';
  loginNIM.value=''; loginPass.value=''; loginError.style.display='none';
}

/* Export kas CSV */
function exportKas(){
  const ks = getKas();
  let csv = 'Nama,Status\\n';
  ks.forEach(k => csv += `"${k.name}","${k.paid ? 'Sudah Bayar' : 'Belum Bayar'}"\\n`);
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='kas_kelas.csv'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* Utility */
function formatDeadline(d){
  const now = new Date(); const diff = d - now; const days = Math.ceil(diff/(1000*60*60*24));
  if(days < 0) return 'Terlambat'; if(days===0) return 'Hari ini'; if(days===1) return 'Besok'; return `${days} hari lagi`;
}
function escapeHtml(s){ return s? s.replace(/[&<>"'`]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'})[c]) : ''; }

/* Modal helpers */
function openModal(id){ document.getElementById(id).classList.add('active'); }
function closeModal(id){ document.getElementById(id).classList.remove('active'); }

/* Init on load: if logged in, auto-show app */
window.addEventListener('DOMContentLoaded', ()=> {
  const cur = getCurrent();
  if(cur){ onLogin(); } else { /* overlay visible by default */ }
});

/* Close modal on outside click */
window.onclick = function(e){
  if(e.target.classList && e.target.classList.contains('modal')) e.target.classList.remove('active');
  // login overlay shouldn't be closed by outside click to force authentication
};

</script>
</body>
</html>
